<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Label Imposition Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .upload-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: block;
            padding: 40px;
            background: #3498db;
            color: white;
            text-align: center;
            border-radius: 5px;
            font-size: 1.2em;
            transition: all 0.3s;
            border: 3px dashed transparent;
        }

        .file-input-label:hover {
            background: #2980b9;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .file-input-label.drag-over {
            background: #2980b9;
            border-color: white;
            transform: scale(1.02);
        }

        .file-icon {
            font-size: 3em;
            margin-bottom: 10px;
            display: block;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .info-card h3 {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .info-card p {
            color: #2c3e50;
            font-size: 1.5em;
            font-weight: bold;
        }

        .viewer-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }

        .viewer-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .viewer-controls h2 {
            color: #2c3e50;
            margin: 0;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #27ae60;
            color: white;
        }

        .btn-primary:hover {
            background: #229954;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        #pdfViewer {
            width: 100%;
            height: 800px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: auto;
            background: #e0e0e0;
            position: relative;
        }

        #pdfCanvas {
            display: block;
            margin: 0 auto;
            background-color: #e0e0e0;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2em;
            color: #7f8c8d;
        }

        .page-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .page-info {
            color: #7f8c8d;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zoom-controls button {
            padding: 5px 10px;
            font-size: 1.2em;
        }

        .zoom-info {
            color: #7f8c8d;
            min-width: 60px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PDF Label Imposition Tool</h1>
        
        <div class="upload-section">
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" class="file-input" accept=".pdf">
                <label for="fileInput" class="file-input-label" id="dropZone">
                    <span class="file-icon">ðŸ“„</span>
                    <span id="dropText">Drag & drop your PDF here or click to browse</span>
                </label>
            </div>
            
            <div class="info-grid" id="infoGrid" style="display: none;">
                <div class="info-card">
                    <h3>Original Size</h3>
                    <p id="originalSize">-</p>
                </div>
                <div class="info-card">
                    <h3>Grid Layout</h3>
                    <p id="gridLayout">-</p>
                </div>
                <div class="info-card">
                    <h3>Labels per Sheet</h3>
                    <p id="labelsPerSheet">-</p>
                </div>
                <div class="info-card">
                    <h3>Orientation</h3>
                    <p id="orientation">-</p>
                </div>
            </div>
        </div>

        <div class="viewer-section" id="viewerSection">
            <div class="viewer-controls">
                <h2>Imposed PDF Preview</h2>
                <div class="button-group">
                    <div class="zoom-controls">
                        <button class="btn-secondary" onclick="zoomOut()">âˆ’</button>
                        <span class="zoom-info" id="zoomInfo">100%</span>
                        <button class="btn-secondary" onclick="zoomIn()">+</button>
                    </div>
                    <!-- <button class="btn-primary" onclick="downloadPDF()">Download Imposed PDF</button> -->
                </div>
            </div>
            <div id="pdfViewer">
                <canvas id="pdfCanvas"></canvas>
                <div class="loading" id="loading">Processing...</div>
            </div>
        </div>
    </div>

    <script>
        // Set worker source for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let currentPDF = null;
        let currentZoom = 1;
        let imposedPDFBytes = null;
        let rotatePDFOrientation = false;
        let originalFilename = '';

        // Imposition frame size in mm
        const impositionFrame = {
            width: 321,
            height: 830
        };

        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') {
                alert('Please select a valid PDF file');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('pdfCanvas').style.display = 'none';
            
            // Store the original filename without extension
            originalFilename = file.name.replace(/\.pdf$/i, '');

            try {
                const arrayBuffer = await file.arrayBuffer();
                await processAndImposePDF(arrayBuffer, file.name);
            } catch (error) {
                console.error('Error processing PDF:', error);
                alert('Error processing PDF: ' + error.message);
            }
        }

        function calculateLabels(widthInches, heightInches) {
            const w = widthInches * 25.4;
            const h = heightInches * 25.4;

            const cols1 = Math.floor(impositionFrame.width / w);
            const rows1 = Math.floor(impositionFrame.height / h);
            const cols2 = Math.floor(impositionFrame.width / h);
            const rows2 = Math.floor(impositionFrame.height / w);

            if (cols1 * rows1 >= cols2 * rows2) {
                rotatePDFOrientation = false;
                return [cols1, rows1];
            } else {
                rotatePDFOrientation = true;
                return [cols2, rows2];
            }
        }

        async function processAndImposePDF(arrayBuffer, filename) {
            const { PDFDocument, degrees, cmyk } = PDFLib;
            
            // Load the PDF with options to preserve quality
            const pdfDoc = await PDFDocument.load(arrayBuffer, {
                updateMetadata: false,
                ignoreEncryption: false
            });
            const firstPage = pdfDoc.getPage(0);
            
            // Get dimensions in inches (72 points = 1 inch)
            const firstPageWidthInches = firstPage.getWidth() / 72;
            const firstPageHeightInches = firstPage.getHeight() / 72;
            
            // Update info display
            document.getElementById('originalSize').textContent = 
                `${firstPageWidthInches.toFixed(2)}" Ã— ${firstPageHeightInches.toFixed(2)}"`;
            
            // Calculate grid layout
            const [cols, rows] = calculateLabels(firstPageWidthInches, firstPageHeightInches);
            document.getElementById('gridLayout').textContent = `${cols} Ã— ${rows}`;
            document.getElementById('labelsPerSheet').textContent = cols * rows;
            document.getElementById('orientation').textContent = 
                rotatePDFOrientation ? 'Rotated 90Â°' : 'Normal';
            document.getElementById('infoGrid').style.display = 'grid';
            
            // Create new PDF document
            const newPdfDoc = await PDFDocument.create();
            
            // Convert mm to points
            const mmToPoints = mm => mm * 2.834645669;
            
            // Add page with imposition frame size
            const newPage = newPdfDoc.addPage([
                mmToPoints(impositionFrame.width), 
                mmToPoints(impositionFrame.height)
            ]);
            
            // Get label dimensions in mm
            let labelWidthInMM, labelHeightInMM;
            if (rotatePDFOrientation) {
                labelWidthInMM = firstPageHeightInches * 25.4;
                labelHeightInMM = firstPageWidthInches * 25.4;
            } else {
                labelWidthInMM = firstPageWidthInches * 25.4;
                labelHeightInMM = firstPageHeightInches * 25.4;
            }
            
            const labelFullWidth = labelWidthInMM * cols;
            const labelFullHeight = labelHeightInMM * rows;
            
            // Calculate gaps
            const horizontalGap = (impositionFrame.width - labelFullWidth) / (cols * 2);
            const verticalGap = (impositionFrame.height - labelFullHeight) / (rows * 2);
            
            // Embed the first page - this preserves the original page's color space and quality
            const [embeddedPage] = await newPdfDoc.embedPdf(pdfDoc, [0]);
            
            // Place PDFs in grid
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const x = mmToPoints(horizontalGap + col * (labelWidthInMM + 2 * horizontalGap));
                    const y = mmToPoints(impositionFrame.height - verticalGap - (row + 1) * labelHeightInMM - row * (2 * verticalGap));
                    
                    if (rotatePDFOrientation) {
                        newPage.drawPage(embeddedPage, {
                            x: x + mmToPoints(labelWidthInMM),
                            y: y,
                            width: embeddedPage.width,
                            height: embeddedPage.height,
                            rotate: degrees(90)
                        });
                    } else {
                        newPage.drawPage(embeddedPage, {
                            x: x,
                            y: y,
                            width: embeddedPage.width,
                            height: embeddedPage.height
                        });
                    }
                }
                
                // Add black square for this row
                // Square is 0.25" x 0.25" (6.35mm x 6.35mm)
                const squareSize = 0.25 * 72; // 0.25 inches in points
                const squareX = mmToPoints(horizontalGap) - mmToPoints(12.9); // 13mm to the left of leftmost position
                const squareY = mmToPoints(impositionFrame.height - verticalGap - (row + 1) * labelHeightInMM - row * (2 * verticalGap)) + 6; // 4 mm above the bottom of the row
                
                // Draw black square using CMYK black
                newPage.drawRectangle({
                    x: squareX,
                    y: squareY,
                    width: squareSize,
                    height: squareSize,
                    color: PDFLib.cmyk(0, 0, 0, 1), // 100% K black in CMYK
                    borderWidth: 0
                });
            }
            
            // Save the new PDF
            imposedPDFBytes = await newPdfDoc.save();
            
            console.log('PDF created, size:', imposedPDFBytes.length, 'bytes');
            
            // Download immediately after creation
            downloadPDF();
            
            // Display the PDF
            await displayPDF(imposedPDFBytes);
            
            // Show viewer section
            document.getElementById('viewerSection').style.display = 'block';
        }

        async function displayPDF(pdfBytes) {
            const loadingTask = pdfjsLib.getDocument({ data: pdfBytes });
            currentPDF = await loadingTask.promise;
            
            await renderPage(1);
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('pdfCanvas').style.display = 'block';
        }

        async function renderPage(pageNum) {
			
            const page = await currentPDF.getPage(pageNum);
            const viewport = page.getViewport({ scale: currentZoom });
            
            const canvas = document.getElementById('pdfCanvas');
            const context = canvas.getContext('2d');
            
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            
            await page.render(renderContext);
        }

        function zoomIn() {
            if (currentZoom < 3) {
                currentZoom += 0.25;
                updateZoom();
            }
        }

        function zoomOut() {
            if (currentZoom > 0.25) {
                currentZoom -= 0.25;
                updateZoom();
            }
        }

        function updateZoom() {
            document.getElementById('zoomInfo').textContent = Math.round(currentZoom * 100) + '%';
            if (currentPDF) {
                renderPage(1);
            }
        }

        function downloadPDF() {
            try {
                if (!imposedPDFBytes) {
                    console.error('No PDF bytes available');
                    return;
                }
                
                console.log('Starting download, PDF type:', typeof imposedPDFBytes);
                console.log('PDF bytes length:', imposedPDFBytes.byteLength || imposedPDFBytes.length);
                console.log('First few bytes:', Array.from(imposedPDFBytes.slice(0, 10)));
                
                // Ensure we have a proper Uint8Array
                const pdfData = imposedPDFBytes instanceof Uint8Array ? imposedPDFBytes : new Uint8Array(imposedPDFBytes);
                
                // Create blob with the PDF data
                const blob = new Blob([pdfData], { type: 'application/pdf' });
                console.log('Blob size:', blob.size);
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = originalFilename + '_imposed.pdf';
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }, 100);
                
                console.log('Download initiated successfully');
            } catch (error) {
                console.error('Error in downloadPDF:', error);
                alert('Error downloading PDF: ' + error.message);
            }
        }
    </script>
</body>
</html>